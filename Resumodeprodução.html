<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor de Relat√≥rios PEC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: #fff;
      margin: 20px;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
      font-size: 1.6rem;
    }
    input[type=file] {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
    }
    .card {
      background: #f9fbfd;
      border: 1px solid #e0e6ed;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #007bff;
    }
    .card p {
      margin: 4px 0;
      font-size: 0.95rem;
    }
    button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    #status {
      text-align: center;
      margin-bottom: 1rem;
      color: #6b7280;
    }
    @media (max-width: 480px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      h1 { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìë Leitor de Relat√≥rios PEC</h1>
    <input type="file" id="upload" accept="application/pdf" />
    <div id="status"></div>
    <div id="cards"></div>
    <button id="downloadExcel" style="display:none;">‚¨áÔ∏è Baixar Excel</button>
  </div>

  <script>
    // Configura o worker da PDF.js para processar o PDF
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

    let dadosExtraidos = {};

    document.addEventListener('DOMContentLoaded', () => {
      const uploadInput = document.getElementById('upload');
      const cardsDiv = document.getElementById('cards');
      const downloadExcelBtn = document.getElementById('downloadExcel');
      const statusDiv = document.getElementById('status');

      uploadInput.addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        statusDiv.textContent = `üîç Processando: ${file.name}`;
        cardsDiv.innerHTML = '';
        downloadExcelBtn.style.display = 'none';

        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

          let textoCompleto = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const strings = content.items.map(item => item.str).join(" ");
            textoCompleto += strings + "\n";
          }
          
          function extrair(pattern) {
            const match = textoCompleto.match(pattern);
            return match && match[1] ? match[1].trim() : "0";
          }
          
          function encontrarValor(regex, texto) {
            const match = texto.match(regex);
            return match ? parseInt(match[1]) : 0;
          }

          dadosExtraidos = {
            resumo: {
              registrosIdentificados: encontrarValor(/Registros identificados\s*(\d+)/i, textoCompleto),
              registrosNaoIdentificados: encontrarValor(/Registros n√£o identificados\s*(\d+)/i, textoCompleto),
              total: encontrarValor(/Total:?\s*(\d+)/i, textoCompleto)
            },
            ciap2: {
              W78: encontrarValor(/W78\s*-\s*Gravidez.*?(\d+)/i, textoCompleto),
              T90: encontrarValor(/T90\s*-\s*Diabetes\s+N√£o\s+Insulino-Dependente.*?(\d+)/i, textoCompleto),
              K86: encontrarValor(/K86\s*-\s*Hipertens√£o\s+Sem\s+Complica√ß√µes.*?(\d+)/i, textoCompleto)
            },
            cid10: {
              I10: encontrarValor(/I10\s*-\s*Hipertens√£o\s+Essencial\s+\(Prim√°ria\).*?(\d+)/i, textoCompleto),
              E10: encontrarValor(/E10\s*-\s*Diabetes\s+Mellitus\s+Insulino-Dependente.*?(\d+)/i, textoCompleto)
            },
            gerais: {
              puericultura: encontrarValor(/Puericultura:\s*(\d+)/i, textoCompleto),
              gestantes: encontrarValor(/Gestantes:\s*(\d+)/i, textoCompleto)
            },
            exames: {
              hemoglobina: encontrarValor(/Hemoglobina\s+Glicada.*?(\d+)/i, textoCompleto),
              ultrassonografia: (() => {
                const matches = [...textoCompleto.matchAll(/ULTRASSONOGRAFIA.*?(\d+)/gi)];
                return matches.reduce((sum, match) => sum + parseInt(match[1]), 0);
              })(),
              eletrocardiograma: encontrarValor(/Eletrocardiograma.*?(\d+)/i, textoCompleto)
            }
          };

          const createCard = (title, data) => {
            let html = `<div class="card"><h2>${title}</h2>`;
            for (const key in data) {
              html += `<p>${key}: ${data[key]}</p>`;
            }
            html += `</div>`;
            return html;
          };

          cardsDiv.innerHTML = `
            ${createCard('üìä Resumo de Produ√ß√£o', dadosExtraidos.resumo)}
            ${createCard('ü©∫ Problemas/Condi√ß√µes - CIAP2', dadosExtraidos.ciap2)}
            ${createCard('üìñ Problemas/Condi√ß√µes - CID10', dadosExtraidos.cid10)}
            ${createCard('üë∂ Problemas/Condi√ß√µes Gerais', dadosExtraidos.gerais)}
            ${createCard('üî¨ Exames Solicitados', dadosExtraidos.exames)}
          `;
          
          downloadExcelBtn.style.display = 'block';
          statusDiv.textContent = `‚úÖ ${file.name} processado com sucesso!`;

        } catch (error) {
          statusDiv.textContent = `‚ùå Erro ao processar o arquivo: ${error.message}`;
          console.error(error);
          cardsDiv.innerHTML = '';
          downloadExcelBtn.style.display = 'none';
        }
      });

      downloadExcelBtn.addEventListener("click", function () {
        const ws_data = [
          ["Categoria", "Indicador", "Valor"],
          ["Resumo de Produ√ß√£o", "Registros Identificados", dadosExtraidos.resumo.registrosIdentificados],
          ["Resumo de Produ√ß√£o", "Registros N√£o Identificados", dadosExtraidos.resumo.registrosNaoIdentificados],
          ["Resumo de Produ√ß√£o", "Total", dadosExtraidos.resumo.total],
          ["CIAP2", "W78 - Gravidez", dadosExtraidos.ciap2.W78],
          ["CIAP2", "T90 - Diabetes N√£o Insulino-Dependente", dadosExtraidos.ciap2.T90],
          ["CIAP2", "K86 - Hipertens√£o Sem Complica√ß√µes", dadosExtraidos.ciap2.K86],
          ["CID10", "I10 - Hipertens√£o Essencial (Prim√°ria)", dadosExtraidos.cid10.I10],
          ["CID10", "E10 - Diabetes Mellitus Insulino-Dependente", dadosExtraidos.cid10.E10],
          ["Gerais", "Puericultura", dadosExtraidos.gerais.puericultura],
          ["Gerais", "Gestantes", dadosExtraidos.gerais.gestantes],
          ["Exames Solicitados", "Hemoglobina Glicada", dadosExtraidos.exames.hemoglobina],
          ["Exames Solicitados", "Ultrassonografia", dadosExtraidos.exames.ultrassonografia],
          ["Exames Solicitados", "Eletrocardiograma", dadosExtraidos.exames.eletrocardiograma]
        ];

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Resumo");

        XLSX.writeFile(wb, "resumo_producao.xlsx");
      });
    });
  </script>
</body>
</html>
