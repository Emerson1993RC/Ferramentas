<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Leitor de Relat√≥rios PEC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: #fff;
      margin: 20px;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
      font-size: 1.6rem;
    }
    input[type=file] {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
    }
    .card {
      background: #f9fbfd;
      border: 1px solid #e0e6ed;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #007bff;
    }
    .card p {
      margin: 4px 0;
      font-size: 0.95rem;
    }
    button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    @media (max-width: 480px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      h1 { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìë Leitor de Relat√≥rios PEC</h1>
    <input type="file" id="upload" accept="application/pdf" />
    <div id="cards"></div>
    <button id="downloadExcel" style="display:none;">‚¨áÔ∏è Baixar Excel</button>
  </div>

  <script>
    let dadosExtraidos = {};

    document.getElementById('upload').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let textoCompleto = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        textoCompleto += strings.join(" ") + "\n";
      }

      function extrair(pattern) {
        const match = textoCompleto.match(pattern);
        return match ? match[1] : "0";
      }

      dadosExtraidos = {
        resumo: {
          registrosIdentificados: extrair(/Registros\s+identificados\s+(\d+)/i),
          registrosNaoIdentificados: extrair(/Registros\s+n[√£a]o\s+identificados\s+(\d+)/i),
          total: extrair(/(\d+)\s*Total:/i)
        },
        ciap2: {
          W78: extrair(/W78\s*-\s*GRAVIDEZ\s+(\d+)/i),
          T90: extrair(/T90\s*-\s*DIABETES\s+N[√ÉA]O\s+INSULINO.*DEPENDENTE\s+(\d+)/i),
          K86: extrair(/K86\s*-\s*HIPERTENS[√ÉA]O\s+SEM\s+COMPLICA[√áC][√ÉA]OES\s+(\d+)/i)
        },
        cid10: {
          I10: extrair(/I10\s*-\s*HIPERTENS[√ÉA]O\s+ESSENCIAL.*?\s+(\d+)/i),
          E10: extrair(/E10\s*-\s*DIABETES\s+MELLITUS\s+INSULINO.*DEPENDENTE\s+(\d+)/i)
        },
        gerais: {
          puericultura: extrair(/Puericultura\s+(\d+)/i),
          gestantes: extrair(/Gestante\s+(\d+)/i)
        }
      };

      const cardsDiv = document.getElementById("cards");
      cardsDiv.innerHTML = `
        <div class="card">
          <h2>üìä Resumo de Produ√ß√£o</h2>
          <p>Registros Identificados: ${dadosExtraidos.resumo.registrosIdentificados}</p>
          <p>Registros N√£o Identificados: ${dadosExtraidos.resumo.registrosNaoIdentificados}</p>
          <p>Total: ${dadosExtraidos.resumo.total}</p>
        </div>
        <div class="card">
          <h2>ü©∫ Problemas/Condi√ß√µes - CIAP2</h2>
          <p>W78 - Gravidez: ${dadosExtraidos.ciap2.W78}</p>
          <p>T90 - Diabetes N√£o Insulino-Dependente: ${dadosExtraidos.ciap2.T90}</p>
          <p>K86 - Hipertens√£o Sem Complica√ß√µes: ${dadosExtraidos.ciap2.K86}</p>
        </div>
        <div class="card">
          <h2>üìñ Problemas/Condi√ß√µes - CID10</h2>
          <p>I10 - Hipertens√£o Essencial (Prim√°ria): ${dadosExtraidos.cid10.I10}</p>
          <p>E10 - Diabetes Mellitus Insulino-Dependente: ${dadosExtraidos.cid10.E10}</p>
        </div>
        <div class="card">
          <h2>üë∂ Problemas/Condi√ß√µes Gerais</h2>
          <p>Puericultura: ${dadosExtraidos.gerais.puericultura}</p>
          <p>Gestantes: ${dadosExtraidos.gerais.gestantes}</p>
        </div>
      `;

      document.getElementById("downloadExcel").style.display = "block";
    });

    document.getElementById("downloadExcel").addEventListener("click", function () {
      const ws_data = [
        ["Categoria", "Indicador", "Valor"],
        ["Resumo de Produ√ß√£o", "Registros Identificados", dadosExtraidos.resumo.registrosIdentificados],
        ["Resumo de Produ√ß√£o", "Registros N√£o Identificados", dadosExtraidos.resumo.registrosNaoIdentificados],
        ["Resumo de Produ√ß√£o", "Total", dadosExtraidos.resumo.total],
        ["CIAP2", "W78 - Gravidez", dadosExtraidos.ciap2.W78],
        ["CIAP2", "T90 - Diabetes N√£o Insulino-Dependente", dadosExtraidos.ciap2.T90],
        ["CIAP2", "K86 - Hipertens√£o Sem Complica√ß√µes", dadosExtraidos.ciap2.K86],
        ["CID10", "I10 - Hipertens√£o Essencial (Prim√°ria)", dadosExtraidos.cid10.I10],
        ["CID10", "E10 - Diabetes Mellitus Insulino-Dependente", dadosExtraidos.cid10.E10],
        ["Gerais", "Puericultura", dadosExtraidos.gerais.puericultura],
        ["Gerais", "Gestantes", dadosExtraidos.gerais.gestantes]
      ];

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Resumo");

      XLSX.writeFile(wb, "resumo_producao.xlsx");
    });
  </script>
</body>
</html>
